 râ†eWC_test sink;tests;demos;d;â•TRAP;f;t;file;sup;rC;z;lastd;dl;de;from;to;arg;msg;src;_Env;DEFAULTS;v;pi;sp;Supported;PropList;up;ctl;data;get
â this is admittedly an ugly hack - but I didn't want to waste time fixing it just now...
â the problem is that the DTest DSL assumes tests are executed in the ns that DTest created while running the test -
â but these tests are executed in #.tests.demo.
â So we make the most populare variables and functions available:
 #.tests.demo.Checkâ†Check
 #.tests.demo.Assertâ†Assert
 #.tests.haltâ†##.halt
 #.tests.traceâ†##.trace
 #.tests.verboseâ†##.verbose
 #.tests.dtbâ†##.dtb  â needed by check

 testsâ†#.tests.demo.â•NL Â¯3
 testsâ†{((âŠ‚'Test')â‰¡Â¨4â†‘Â¨âµ)/âµ}tests
 demosâ†{2âŠƒâ•NPARTS âµ}Â¨âŠƒ0(â•NINFOâ 1)EWC_DPATH,'/Demo*.*'
 DEFAULTSâ†0(â•JSONâ 'Dialect' 'JSON5')(1âŠƒâ•NGET ##.TESTSOURCE,'eWC_defaults.json5')
 '['â•NPUT(EWC_HOME,'JSWC/objectlog.json5')1  â initialise this file so that we can append single log objects to it...
 râ†''
 dlâ†â¬  â demo list we want to run
 deâ†â¬  â demos we NOT want to run
 argâ†1â†“##.args.Arguments   â 1st element of arg is the name of the .dylogtest
 _Envâ†{
    â get value of environment variable or #-based variable (case-sensitive, prefixed with 'EWC_')
    â defaults taken from DEFAULTS ns.
     zâ†2 â•NQ #'GetEnvironment'âµ
     defâ†{2=#.â•NC'EWC_',âµ:#â'EWC_',âµ â‹„ DEFAULTSââµ}âµ
     0=â‰¢z:def
     (â•DR def)âˆŠ80 160:âµ
     2âŠƒâ•VFI âµ
 }

 :If 0<â‰¢arg
     :For d :In arg
         :If '~'=âŠƒd
             de,â†âŠ‚1â†“d
         :ElseIf âˆ¨/'..'â·d
             (from to)â†'|'(â‰ âŠ†âŠ¢)' ',(âŠƒ('(.*)\.\.(.*)'â•S'\1|\2')d),' '
             fâ†0
             tâ†â‰¢demos
             :If 0<â‰¢from
                 fâ†demosâ³âŠ‚1â†“from
             :EndIf
             :If 0<â‰¢to
                 tâ†demosâ³âŠ‚Â¯1â†“to
             :EndIf
             dl,â†(f-1)â†“tâ†‘demos
         :Else
             dl,â†âŠ‚d
         :EndIf
     :EndFor
 :Else
     dlâ†(âˆŠ'Demo'âˆ˜â‰¡Â¨4â†‘Â¨demos)/demos
 :EndIf
 dlâ†4â†“Â¨dl
 demosâ†âˆªdl~deâˆª'Menu' 'Default'
 lastdâ†'just started'
 :If 1=1â†‘0 _Env'RANDOMORDER'
     demos[('eWC_order_',â•â‰¢demos)##.RandomVal 2/â‰¢demos]
 :EndIf
 :For d :In demos
     :If (âŠ‚'~',d)âˆŠ##.args.Arguments
         :Continue
     :EndIf
     â inspect the demo to determine coverage of properties, methods and events
     âsrcâ†#.demo.â•NR d
     âwcâ†('''(.*)''\s*eWC\s*''(.*)'''â•S'\1')src  â list of controls that are created (and their names)
     âwsâ†('''(.*)''\s*eWC\s*''.*''\s*(''.*'')*'â•S'\1')src  â props that were set (and names of related controls)
     â nah, impossible - see email to MK
     msgâ†''  â a global var (initialised in eWC_createBrowser)
     :If 0=â•NC'PROCESS'
     :OrIf PROCESS{6::1 â‹„ âºââµ}'HasExited'
         BRWSR eWC_createBrowser MODE
     :EndIf
     :If lastdâ‰¢'just started'
     :AndIf 0<piâ†0 _Env'PROGRESSINDICATOR'
        â 0= no info
        â 1= show name of next test
        â 2= AND wait for keypress
         :Select ,pi
         :Case ,1
             â•â†d
         :Case ,2
             {}ââ†'press <enter> for ',d
         :EndSelect
     :EndIf
     #.S.GoTo ROOT
     #.S.
     zâ†'CssSelector'#.S.Find'[id$="MENU"]'
     :If 326 Check â•DR z    â check if we find the menu
         msgâ†'could not find F1.MENU (possibly something went wrong before (lastd=',lastd,')'    â although that should be veeery unlikely now....
     :Else
         zâ†('CssSelector' '[id$="MENU"]')#.S.Select d      â selecting the test will load it
         :If 1 Check z  â can we select the test in the menu
             msgâ†'test not found in menu (attention: it is case-sensitive!)'
         :Else
             {}â•DL 1  â allow some time to load

             zâ†'CssSelector'#.S.Find'[id$="MENU"]'             â check if loaded test also has a menu...
             :If 326 Check â•DR z
                 msgâ†'could not find F1.MENU'
             :Else
                 zâ†('CssSelector' '[id$="STOP"]')#.S.WaitFor'Stop'
                 :If ''Check z   â wait for the Stop button as an indication that the test has loaded indeed
                     â•â†msgâ†'could not find STOP button'
                     â•â†'z=',z
                     â•TRAPâ†0 'S' â‹„ (â•LC[1]+1)â•STOP 1âŠƒâ•SI
                 :Else
                     tâ†'Test',d   â name of related test
                     :If (âŠ‚t)âˆŠtests  â check if this demo has a test that we can run...
                     tâ†'Test',d   â name of related test
                     :If (âŠ‚t)âˆŠtests  â check if this demo has a test that we can run...
        â run demo d
                         :If ##.trace
                         :OrIf 1 _Env'TRACE_TESTS'
                             1 #.tests.demo.â•STOP t
                         :EndIf
                         msg,â†#.tests.demoât,' â¬'
                     :EndIf
                 :EndIf
             :EndIf
         :EndIf
     :EndIf
     :If 0<vâ†_Env'SCREENSHOT'
         fileâ†âˆŠ1 â•NPARTS ##.TESTSOURCE,d,'.png'
         :If v=2  â always save screenshot
             #.S.SaveScreenshot file
             :If 0<â‰¢msg  â if there was an error, add info abt screenshot
                 msg,â†' - saved screenshot as ',file
             :EndIf
         :ElseIf v=1
             :If 0<â‰¢msg
                 #.S.SaveScreenshot file
                 msg,â†' - saved screenshot as ',file
                 :If ##.halt
                     â•â†'test ',d,' failed!'
                     â•â†'â†’',(â•â•LC[1]+2),'   â to continue'
                     â•TRAPâ†0 'S' â‹„ (â•LC[1]+1)â•STOP 1âŠƒâ•SI
                 :EndIf
             :EndIf
         :EndIf
     :EndIf
     lastdâ†d
     :If 0<â‰¢msg
         r,â†âŠ‚d,': ',msg
         :EndIf
     :EndIf
 :EndFor
 ']'â•NPUT(EWC_HOME,'JSWC/objectlog.json5')2
 dataâ†1âŠƒâ•NGET EWC_HOME,'JSWC/objectlog.json5'
 :If 0<â‰¢data   â unlikely, but better be safe ;)
    â all demos & tests executed - now check the controls that were created
    â and the properties that were tested...
    â also: it seems much better to do this analysis twice - once for the demos and once for the tests
    â as these results answer different questions (which both (test- and demo-authors) should be interested in...
     dataâ†(â•JSONâ 'Dialect' 'JSON5')data
     getâ†{
         âº{6::â¬
             âºââµ
         }Â¨âŠ‚âµ
     }
     :For ctl :In (âˆªdata get'Type')~âŠ‚â¬
         upâ†(ctlâˆ˜â‰¡Â¨data get'Type')/data get'Properties'   â used properties
         upâ†âˆªâŠƒ,/up
         {}'(overwrite:1)'â•SE.Link.Import(â•THIS)(EWC_HOME,'JSWC/Classes/',(â•C ctl),'/Supported.apla')
         {}'(overwrite:1)'â•SE.Link.Import(â•THIS)(EWC_HOME,'JSWC/Classes/',(â•C ctl),'/PropList.apla')
         spâ†Supportedâˆ©PropList
         :If âˆ¨/zâ†~spâˆŠup
             msg,â†'Supported props of "',ctl,'" that were not used in the demos or tests: ',Â¯1â†“âˆŠ{'"',âµ,'" ,'}Â¨z/sp
         :EndIf
     â what else can we test...???
     â - check that dynamic properties are set AND read
     â also report the demos that don't have tests for (yet)

     :EndFor
 :EndIf

 :If 0<â‰¢r
     râ†âˆŠ(âŠ‚â•UCS 13 10),Â¨r
 :Else
     â•â†(â•â‰¢demos),' demo pages were opened and ',(â•tests),' tests were excuted without issues!'
     â•â†'ğŸ‘'   â emotional & motivational message
 :EndIf
